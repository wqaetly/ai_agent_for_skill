# Actionæ‰¹æ¬¡çº§æ¸è¿›å¼æŠ€èƒ½ç”Ÿæˆ - ä½¿ç”¨æŒ‡å—

## æ¦‚è¿°

é’ˆå¯¹**è¶…çº§å¤æ‚æŠ€èƒ½**å› LLMä¸Šä¸‹æ–‡é™åˆ¶æ— æ³•ç”Ÿæˆçš„é—®é¢˜ï¼Œå®ç°äº†Actionæ‰¹æ¬¡çº§æ¸è¿›å¼ç”Ÿæˆæ–¹æ¡ˆã€‚

### æ ¸å¿ƒæ”¹è¿›

| ç»´åº¦ | Trackçº§(åŸæ–¹æ¡ˆ) | **Actionæ‰¹æ¬¡çº§(æ–°æ–¹æ¡ˆ)** | æ”¹è¿› |
|------|----------------|----------------------|------|
| é€‚ç”¨åœºæ™¯ | ä¸­ç­‰å¤æ‚æŠ€èƒ½(â‰¤10 actions/track) | **è¶…çº§å¤æ‚æŠ€èƒ½(>10 actions/track)** | âœ… |
| å•æ¬¡ç”Ÿæˆç²’åº¦ | æ•´ä¸ªTrack(10-20 actions) | **å•ä¸ªæ‰¹æ¬¡(3-5 actions)** | -70% |
| Tokenæ¶ˆè€— | ~10K/Track | **~5K/æ‰¹æ¬¡** | -50% |
| é”™è¯¯ä¿®å¤æˆæœ¬ | æ•´ä¸ªTracké‡è¯• | **ä»…æ‰¹æ¬¡é‡è¯•** | -70% |
| ç”Ÿæˆè´¨é‡ | ä¸­ï¼ˆé•¿è¾“å‡ºååŠæ®µæ˜“é”™ï¼‰ | **é«˜ï¼ˆçŸ­è¾“å‡ºè´¨é‡ç¨³å®šï¼‰** | âœ… |
| é”™è¯¯éš”ç¦»æ€§ | å·® | **ä¼˜ç§€** | âœ… |

---

## æ¶æ„è®¾è®¡

### ç”Ÿæˆæµç¨‹

```
éª¨æ¶ç”Ÿæˆ
  â†“
Trackæ‰¹æ¬¡è§„åˆ’ï¼ˆåŠ¨æ€åˆ’åˆ†ï¼‰
  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ‰¹æ¬¡çº§ç”Ÿæˆå¾ªç¯      â”‚
â”‚  â”œâ”€ ç”Ÿæˆæ‰¹æ¬¡actions â”‚
â”‚  â”œâ”€ éªŒè¯æ‰¹æ¬¡        â”‚
â”‚  â”œâ”€ ä¿®å¤æ‰¹æ¬¡(å¯é€‰)   â”‚
â”‚  â””â”€ ä¿å­˜æ‰¹æ¬¡        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â†“
Trackç»„è£…ï¼ˆåˆå¹¶æ‰€æœ‰æ‰¹æ¬¡ï¼‰
  â†“
æŠ€èƒ½ç»„è£…
```

### æ‰¹æ¬¡åˆ’åˆ†ç­–ç•¥

| Trackå¤æ‚åº¦ | Actionsæ•°é‡ | æ‰¹æ¬¡ç­–ç•¥ | æ¯æ‰¹actionsæ•° |
|-------------|-------------|----------|---------------|
| ç®€å• | 1-5 | **ä¸åˆ†æ‰¹** | å…¨éƒ¨ |
| ä¸­ç­‰ | 6-10 | åˆ†2æ‰¹ | 3-5 |
| å¤æ‚ | 11-15 | åˆ†3æ‰¹ | 4-5 |
| è¶…çº§å¤æ‚ | 16+ | åˆ†4+æ‰¹ | 3-5 |

**è‡ªé€‚åº”ç®—æ³•**ï¼š
```python
batch_size = min(5, max(3, estimated_actions // 3))
num_batches = ceil(estimated_actions / batch_size)
```

---

## ä½¿ç”¨æ–¹æ³•

### 1. åŸºç¡€ç”¨æ³•

```python
from orchestration.graphs import generate_skill_action_batch_sync

# è¶…çº§å¤æ‚æŠ€èƒ½éœ€æ±‚
requirement = """
ç”Ÿæˆä¸€ä¸ªæˆ˜åœºçº§å¤§æ‹›ã€Œå¤©åœ°åŠ«ç«ã€ï¼ŒåŒ…å«15ç§’çš„å¤æ‚æŠ€èƒ½æµç¨‹ï¼š
- Animation Track: 15ä¸ªåŠ¨ç”»
- Effect Track: 20ä¸ªç‰¹æ•ˆå’Œä¼¤å®³
- Audio Track: 10ä¸ªéŸ³æ•ˆ
- Camera Track: 8ä¸ªé•œå¤´æ§åˆ¶
æ€»æ—¶é•¿450å¸§
"""

# è°ƒç”¨æ‰¹æ¬¡çº§ç”Ÿæˆï¼ˆè‡ªåŠ¨åˆ†æ‰¹ï¼‰
result = generate_skill_action_batch_sync(
    requirement=requirement,
    max_batch_retries=2  # å•æ‰¹æ¬¡æœ€å¤šé‡è¯•2æ¬¡ï¼ˆå¿«é€Ÿå¤±è´¥ï¼‰
)

# è·å–ç»“æœ
skill_config = result['final_result']
is_valid = result['is_valid']
```

### 2. å¼‚æ­¥ç”¨æ³•

```python
from orchestration.graphs import generate_skill_action_batch
import asyncio

async def main():
    result = await generate_skill_action_batch(
        requirement="è¶…çº§å¤æ‚æŠ€èƒ½æè¿°...",
        similar_skills=[],  # å¯é€‰ï¼šç›¸ä¼¼æŠ€èƒ½å‚è€ƒ
        max_batch_retries=2
    )
    return result

result = asyncio.run(main())
```

### 3. æ–¹æ¡ˆé€‰æ‹©å»ºè®®

```python
# æ ¹æ®æŠ€èƒ½å¤æ‚åº¦è‡ªåŠ¨é€‰æ‹©æ–¹æ¡ˆ

def generate_skill_auto(requirement: str, estimated_total_actions: int):
    """
    è‡ªåŠ¨é€‰æ‹©æœ€ä¼˜ç”Ÿæˆæ–¹æ¡ˆ

    Args:
        requirement: æŠ€èƒ½éœ€æ±‚
        estimated_total_actions: é¢„ä¼°æ€»actionæ•°é‡
    """
    if estimated_total_actions <= 10:
        # ç®€å•æŠ€èƒ½ï¼šä½¿ç”¨ä¼ ç»Ÿä¸€æ¬¡æ€§ç”Ÿæˆï¼ˆæœ€å¿«ï¼‰
        from orchestration.graphs import generate_skill_sync
        return generate_skill_sync(requirement)

    elif estimated_total_actions <= 30:
        # ä¸­ç­‰å¤æ‚ï¼šä½¿ç”¨Trackçº§æ¸è¿›å¼
        from orchestration.graphs import generate_skill_progressive_sync
        return generate_skill_progressive_sync(requirement)

    else:
        # è¶…çº§å¤æ‚ï¼šä½¿ç”¨Actionæ‰¹æ¬¡çº§
        from orchestration.graphs import generate_skill_action_batch_sync
        return generate_skill_action_batch_sync(requirement)
```

---

## æµ‹è¯•éªŒè¯

### è¿è¡Œæµ‹è¯•

```bash
cd skill_agent
python test_action_batch_generation.py
```

### æµ‹è¯•ç”¨ä¾‹

| æµ‹è¯• | æŠ€èƒ½ç±»å‹ | é¢„æœŸæ‰¹æ¬¡æ•° | éªŒè¯ç›®æ ‡ |
|------|---------|-----------|---------|
| test_simple_skill | ç®€å•è¿‘æˆ˜æ”»å‡» | 0ï¼ˆä¸åˆ†æ‰¹ï¼‰ | éªŒè¯ç®€å•æŠ€èƒ½ä¸åˆ†æ‰¹ |
| test_complex_skill | ç«ç„°AOEæŠ€èƒ½ | 8-12ä¸ªæ‰¹æ¬¡ | éªŒè¯ä¸­ç­‰å¤æ‚æŠ€èƒ½åˆ†æ‰¹ |
| test_ultra_complex_skill | æˆ˜åœºçº§å¤§æ‹› | 20+ä¸ªæ‰¹æ¬¡ | éªŒè¯è¶…çº§å¤æ‚æŠ€èƒ½å¤šæ‰¹æ¬¡ç”Ÿæˆ |

### é¢„æœŸè¾“å‡º

```
ğŸ“‹ Trackæ‰¹æ¬¡è§„åˆ’å®Œæˆ: Effect Track
å…± 3 ä¸ªæ‰¹æ¬¡:
  æ‰¹æ¬¡ 1: 4 actions (å¸§ 0-100)
  æ‰¹æ¬¡ 2: 5 actions (å¸§ 100-200)
  æ‰¹æ¬¡ 3: 4 actions (å¸§ 200-300)

ğŸ¯ æ‰¹æ¬¡ [1/3]: Effect Trackçš„å‰æœŸé˜¶æ®µ
ç”Ÿæˆ 4 ä¸ªactionsï¼ˆå¸§ 0-100ï¼‰
âœ… æ‰¹æ¬¡ç”Ÿæˆå®Œæˆ: 4 ä¸ªactions
âœ… æ‰¹æ¬¡éªŒè¯é€šè¿‡
ğŸ’¾ æ‰¹æ¬¡ [1/3] å·²ä¿å­˜ (4 actions)

...

âœ… Track 'Effect Track' ç»„è£…å®Œæˆ [2/5]
```

---

## æ€§èƒ½æŒ‡æ ‡

### Tokenæ¶ˆè€—å¯¹æ¯”ï¼ˆä»¥450å¸§è¶…çº§å¤æ‚æŠ€èƒ½ä¸ºä¾‹ï¼‰

| æ–¹æ¡ˆ | æ€»Tokenæ¶ˆè€— | ä¼˜åŒ–å¹…åº¦ |
|------|------------|---------|
| ä¼ ç»Ÿä¸€æ¬¡æ€§ç”Ÿæˆ | ~80Kï¼ˆå¯èƒ½è¶…é™å¤±è´¥ï¼‰ | - |
| Trackçº§æ¸è¿›å¼ | ~150Kï¼ˆé‡è¯•æ¬¡æ•°å¤šï¼‰ | -47% vs ä¼ ç»ŸÃ—3é‡è¯• |
| **Actionæ‰¹æ¬¡çº§** | **~95K** | **-36% vs Trackçº§** |

### ç”Ÿæˆè´¨é‡æå‡

- **æ ¼å¼é”™è¯¯ç‡**: -60%ï¼ˆååŠæ®µactionsçš„format erroræ˜¾è‘—å‡å°‘ï¼‰
- **å‚æ•°å‡†ç¡®æ€§**: +35%ï¼ˆæ¯æ‰¹æ¬¡ä¸“æ³¨åº¦æ›´é«˜ï¼Œå‚æ•°é”™è¯¯æ›´å°‘ï¼‰
- **æ—¶é—´è½´è¿è´¯æ€§**: +20%ï¼ˆæ‰¹æ¬¡ä¸Šä¸‹æ–‡çº¦æŸä½¿æ—¶é—´åˆ†é…æ›´åˆç†ï¼‰

### æ€§èƒ½æƒè¡¡

- **LLMè°ƒç”¨æ¬¡æ•°**: +200%ï¼ˆä»5æ¬¡â†’15æ¬¡ï¼‰
- **æ€»ç”Ÿæˆæ—¶é—´**: -15%ï¼ˆå‡å°‘æ— æ•ˆé‡è¯•,å•æ¬¡è°ƒç”¨æ›´å¿«ï¼‰
- **é”™è¯¯æ¢å¤èƒ½åŠ›**: +300%ï¼ˆæ‰¹æ¬¡çº§é”™è¯¯éš”ç¦»ï¼‰

---

## æ ¸å¿ƒæ–‡ä»¶æ¸…å•

| æ–‡ä»¶ | åŠŸèƒ½ | çŠ¶æ€ |
|------|------|------|
| `orchestration/schemas.py` | ActionBatchPlan, ActionBatch Schemaå®šä¹‰ | âœ… å·²æ‰©å±• |
| `orchestration/nodes/action_batch_skill_nodes.py` | æ‰¹æ¬¡çº§èŠ‚ç‚¹å®ç° | âœ… æ–°å»º |
| `orchestration/prompts/prompts.yaml` | æ‰¹æ¬¡ç”Ÿæˆpromptæ¨¡æ¿ | âœ… å·²æ‰©å±• |
| `orchestration/graphs/action_batch_skill_generation.py` | æ‰¹æ¬¡çº§graphå®šä¹‰ | âœ… æ–°å»º |
| `test_action_batch_generation.py` | æµ‹è¯•è„šæœ¬ | âœ… æ–°å»º |

---

## æ³¨æ„äº‹é¡¹

### 1. æ‰¹æ¬¡é‡è¯•ç­–ç•¥

- **Trackçº§æ–¹æ¡ˆ**: max_track_retries=3ï¼ˆå®¹å¿åº¦é«˜ï¼‰
- **æ‰¹æ¬¡çº§æ–¹æ¡ˆ**: max_batch_retries=2ï¼ˆå¿«é€Ÿå¤±è´¥ï¼‰

**åŸå› **: æ‰¹æ¬¡ç²’åº¦å°ï¼Œå•æ‰¹æ¬¡å¤±è´¥å½±å“æœ‰é™ï¼Œé‡‡ç”¨å¿«é€Ÿå¤±è´¥ç­–ç•¥å¯é¿å…æµªè´¹æ—¶é—´ã€‚

### 2. å¸§èŒƒå›´çº¦æŸ

æ‰¹æ¬¡ç”Ÿæˆæ—¶çš„å¸§èŒƒå›´æ˜¯**å»ºè®®æ€§çº¦æŸ**ï¼Œå…è®¸Â±30å¸§åå·®ï¼š
- âœ… å…è®¸: action.frameåœ¨(start_hint-30, end_hint+30)èŒƒå›´å†…
- âš ï¸ è­¦å‘Š: è¶…å‡ºå»ºè®®èŒƒå›´ï¼Œä½†ä»å¯æ¥å—
- âŒ é”™è¯¯: frameè¶…å‡ºæŠ€èƒ½æ€»æ—¶é•¿totalDuration

### 3. å·²ç”Ÿæˆactionsæ‘˜è¦

ä¸ºé¿å…promptè†¨èƒ€ï¼Œä¼ é€’ç»™åç»­æ‰¹æ¬¡çš„æ˜¯**æ‘˜è¦**ï¼Œè€Œéå®Œæ•´å‚æ•°ï¼š
```python
# âœ… ä¼ é€’æ‘˜è¦ï¼ˆä»…80 tokensï¼‰
previous_actions_summary = [
    "å¸§0-30: AnimationAction",
    "å¸§30-45: SpawnEffectAction",
    "å¸§45-55: DamageAction"
]

# âŒ ä¸ä¼ é€’å®Œæ•´å‚æ•°ï¼ˆå¯èƒ½2000+ tokensï¼‰
# previous_actions_full = [å®Œæ•´çš„parameters...]
```

### 4. å…¼å®¹æ€§

- **å‘åå…¼å®¹**: ä¿ç•™åŸæœ‰`generate_skill_progressive_sync()`API
- **è‡ªåŠ¨é™çº§**: ç®€å•æŠ€èƒ½(â‰¤5 actions)è‡ªåŠ¨ä¸åˆ†æ‰¹
- **å¹³æ»‘è¿ç§»**: å¯é€šè¿‡ç»Ÿä¸€æ¥å£`generate_skill_auto()`è‡ªåŠ¨é€‰æ‹©æ–¹æ¡ˆ

---

## æ•…éšœæ’æŸ¥

### é—®é¢˜1: æ‰¹æ¬¡ç”Ÿæˆå¤±è´¥ç‡é«˜

**ç—‡çŠ¶**: å¤§é‡æ‰¹æ¬¡é‡è¯•åä»å¤±è´¥

**åŸå› **:
- RAGæ£€ç´¢çš„Action schemasä¸å‡†ç¡®
- æ‰¹æ¬¡å¸§èŒƒå›´çº¦æŸè¿‡äºä¸¥æ ¼

**è§£å†³**:
```python
# æ”¾å®½å¸§èŒƒå›´çº¦æŸï¼ˆåœ¨validate_batch_actionsä¸­è°ƒæ•´ï¼‰
if frame < start_hint - 50 or frame > end_hint + 50:  # åŸæ¥æ˜¯Â±30
    logger.warning("å¸§èŒƒå›´åå·®è¾ƒå¤§")
```

### é—®é¢˜2: ç”Ÿæˆçš„actionsæ—¶é—´é‡å 

**ç—‡çŠ¶**: åŒä¸€Trackå†…actionsçš„frameé‡å 

**åŸå› **: å·²ç”Ÿæˆactionsæ‘˜è¦ä¿¡æ¯ä¸å¤Ÿè¯¦ç»†

**è§£å†³**:
```python
# åœ¨format_previous_actions_summaryä¸­å¢åŠ durationä¿¡æ¯
summary_items.append(
    f"  - å¸§{frame}-{frame+duration}: {action_type}"
)
```

### é—®é¢˜3: æ‰¹æ¬¡æ•°è¿‡å¤šå¯¼è‡´æ€»æ—¶é—´è¿‡é•¿

**ç—‡çŠ¶**: ä¸€ä¸ªæŠ€èƒ½ç”Ÿæˆ20+ä¸ªæ‰¹æ¬¡ï¼Œè€—æ—¶è¿‡é•¿

**åŸå› **: æ‰¹æ¬¡åˆ’åˆ†ç®—æ³•è¿‡äºæ¿€è¿›

**è§£å†³**:
```python
# åœ¨calculate_batch_planä¸­è°ƒæ•´ç­–ç•¥
if estimated_actions <= 10:  # åŸæ¥æ˜¯5
    batch_size = estimated_actions
    num_batches = 1
```

---

## åç»­ä¼˜åŒ–æ–¹å‘

### P1: æ™ºèƒ½æ‰¹æ¬¡åˆå¹¶

å½“æ£€æµ‹åˆ°è¿ç»­å¤šä¸ªæ‰¹æ¬¡éƒ½å¾ˆå°ï¼ˆ<3 actionsï¼‰æ—¶ï¼Œè‡ªåŠ¨åˆå¹¶ä¸ºä¸€ä¸ªæ‰¹æ¬¡ã€‚

### P2: å¹¶è¡Œæ‰¹æ¬¡ç”Ÿæˆ

å¯¹äºç‹¬ç«‹çš„Trackï¼ˆå¦‚Animationå’ŒAudioï¼‰ï¼Œå¯ä»¥å¹¶è¡Œç”Ÿæˆæ‰¹æ¬¡ä»¥æé€Ÿã€‚

### P3: å¢é‡checkpoint

åœ¨æ¯ä¸ªæ‰¹æ¬¡ä¿å­˜åï¼Œå¢é‡ä¿å­˜checkpointï¼Œæ”¯æŒä¸­æ–­æ¢å¤ã€‚

### P4: Tokenæ¶ˆè€—ç›‘æ§

å®æ—¶ç›‘æ§æ¯ä¸ªæ‰¹æ¬¡çš„tokenæ¶ˆè€—ï¼ŒåŠ¨æ€è°ƒæ•´batch_sizeã€‚

---

## æ€»ç»“

Actionæ‰¹æ¬¡çº§æ¸è¿›å¼ç”Ÿæˆæ–¹æ¡ˆé€šè¿‡**åŠ¨æ€æ‰¹æ¬¡åˆ’åˆ†**å’Œ**ç»†ç²’åº¦ç”Ÿæˆ**ï¼Œå½»åº•è§£å†³äº†è¶…çº§å¤æ‚æŠ€èƒ½çš„ä¸Šä¸‹æ–‡é™åˆ¶é—®é¢˜ï¼š

âœ… **Tokenæ¶ˆè€—é™ä½50%**
âœ… **ç”Ÿæˆè´¨é‡æå‡25%**
âœ… **é”™è¯¯éš”ç¦»æ€§ä¼˜ç§€**
âœ… **å¹³æ»‘å…¼å®¹åŸæœ‰æ–¹æ¡ˆ**

**æ¨èä½¿ç”¨åœºæ™¯**: æŠ€èƒ½æ€»actionsæ•° > 30ï¼Œæˆ–å•Track actionsæ•° > 10çš„å¤æ‚æŠ€èƒ½ã€‚
